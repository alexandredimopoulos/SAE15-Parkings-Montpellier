name: Collecte et Mise à jour du Site

on:
  schedule:
    - cron: "*/10 * * * *"  # S'exécute toutes les 10e minutes (00, 10, 20...)
  workflow_dispatch:        # Permet aussi de le lancer manuellement (bouton "Run workflow")

jobs:
  collect-and-deploy:
    runs-on: ubuntu-latest
    
    # Cette permission est critique : elle autorise le bot à modifier tes fichiers
    permissions:
      contents: write

    steps:
      - name: Récupérer le code (Checkout)
        uses: actions/checkout@v4

      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installer les dépendances
        # On ajoute pandas et plotly pour le script de génération du site
        run: |
          pip install requests pandas plotly

      - name: 1. Lancer la collecte de données
        run: python collect_once.py

      - name: 2. Générer le site Web (index.html)
        # Ce script (que je t'ai donné avant) doit exister à la racine
        run: python generate_site.py

      - name: Commit et Push des changements
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # On ajoute le CSV (données) ET le HTML (site)
          git add data/suivi_global.csv index.html
          # Le "|| echo" évite que le script plante s'il n'y a rien de nouveau
          git commit -m "Auto-update: données et site web" || echo "Aucune modification à enregistrer"
          git push